# 수능수학 적응형 학습 서비스 - 통합 설계

## 프로젝트 개요

수능 수학 문제를 카카오톡을 통해 매일 제공하고, 사용자의 실력에 맞춰 난이도를 조정하는 적응형 학습 서비스

### 핵심 가치
- **적응형 난이도**: 사용자 실력에 맞춘 문제 제공
- **카카오톡 연동**: 익숙한 플랫폼에서 학습
- **Notion 검수**: 20개 속성 + 풍부한 본문 블록으로 체계적 품질 관리
- **학습 추적**: 풀이 기록 및 통계

---

## 시스템 아키텍처

### 전체 구조도
```
┌─────────────────────────────────────────────────────────┐
│                     사용자 (학생)                          │
│                    ↓ 카카오톡 ↓                          │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│              FastAPI 웹 서버 (server/)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐ │
│  │ Auth Routes  │  │ Problem      │  │ Scheduler     │ │
│  │ (카카오 로그인)│  │ Routes       │  │ (자동 발송)    │ │
│  │              │  │ (Admin+API)  │  │               │ │
│  └──────────────┘  └──────────────┘  └───────────────┘ │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │ Dashboard    │  │ Card Routes  │                    │
│  │ (분석/통계)   │  │ (카드 생성)   │                    │
│  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────┘
      ↓              ↓              ↓              ↓
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│ Supabase │  │ Supabase │  │ Kakao    │  │ Notion   │
│ DB       │  │ Storage  │  │ API      │  │ (검수)    │
└──────────┘  └──────────┘  └──────────┘  └──────────┘
```

### 파이프라인 흐름
```
[1] PDF 수집          [2] 이미지 변환         [3] 검수
Google Drive    →    PyMuPDF (250 DPI)   →   Notion (20속성)
                           ↓                    ↓
[6] 발송             [5] 저장              [4] 동기화
KakaoTalk       ←    Supabase DB     ←    sync_to_notion.py
```

---

## 핵심 기능

### 1. PDF 처리 파이프라인

**모듈**: `src/pipeline.py`
- PDF → PNG 변환 (250 DPI, PyMuPDF)
- 하이브리드 문항 분리 (Template + OCR)
- 이미지 크롭/리사이즈 (1600px)
- Supabase Storage 업로드 + DB 등록

### 2. Notion 검수 시스템

**스크립트**: `sync_to_notion.py`
**모듈**: `src/notion_service.py`

```bash
python sync_to_notion.py                              # 전체
python sync_to_notion.py --year 2026                  # 연도별
python sync_to_notion.py --problem-id 2026_CSAT_Q01   # 단일 문제
python sync_to_notion.py --dry-run                    # 미리보기
```

검수 페이지 본문 구성:
- 문제 정보 Callout (과목/단원/배점/유형/정답)
- 문제 이미지 (Supabase URL)
- 풀이 (토글, 2000자 자동 분할)
- 힌트 3단계 (토글, 색상별 Callout)
- 출제 의도 (토글)
- 검수 체크리스트 (8항목)

### 3. Admin 대시보드

**URL**: `http://localhost:8000/problem/admin`

기능:
- 문제 목록 (필터: 상태/연도/시험)
- 연도별 검수 진행률 바
- 이미지 썸네일 (호버 확대)
- 이미지 크롭 (React 모달)
- 카카오톡 발송 버튼
- 통계 카드 (총 문제수, 이미지율, 힌트수, 정답검증율)

### 4. 문제 뷰어

**URL**: `/problem/view/{problem_id}`

기능:
- 문제 이미지 표시 (줌 인/아웃)
- 객관식/주관식 답안 입력
- 정답 확인 + 즉시 피드백
- 힌트 3단계 누적 표시
- 오답 시 풀이 표시 + 학습 피드백
- 카카오톡 웹뷰 호환 (Pure HTML/CSS/JS)

### 5. 카카오톡 메시지 발송

**모듈**: `server/kakao_message.py`, `server/scheduler.py`

- Feed 템플릿 (이미지 + 문제풀기 버튼)
- 토큰 자동 갱신 (만료 10분 전)
- 적응형 문제 선택 (`recommend_next_problem()` RPC)
- 자동 스케줄러 (5분 간격 체크)

### 6. 분석 대시보드

**URL**: `http://localhost:8000/analytics`
- 연도/시험/단원별 문제 현황
- 유저 성과 통계
- 힌트 사용 분석

---

## 데이터베이스 스키마

### problems 테이블
```sql
CREATE TABLE problems (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    problem_id VARCHAR(50) UNIQUE NOT NULL,  -- 2026_CSAT_Q01
    year INT,
    exam VARCHAR(20),           -- CSAT, KICE6, KICE9
    question_no INT,
    score INT,                  -- 2, 3, 4점
    answer VARCHAR(50),
    answer_verified VARCHAR(50),
    answer_type VARCHAR(20),    -- multiple_choice / short_answer
    difficulty INT,             -- 1-5
    subject VARCHAR(50),        -- Math1, Math2
    unit VARCHAR(100),          -- 미분, 적분, 수열 등
    problem_image_url TEXT,
    solution TEXT,
    intent_1 TEXT,
    intent_2 TEXT,
    status VARCHAR(20) DEFAULT 'needs_review',
    notion_page_id VARCHAR(50),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### hints 테이블
```sql
CREATE TABLE hints (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    problem_id VARCHAR(50) REFERENCES problems(problem_id),
    stage INT CHECK (stage IN (1, 2, 3)),
    hint_type VARCHAR(30),     -- concept_direction / key_transformation / decisive_line
    hint_text TEXT,
    UNIQUE(problem_id, stage)
);
```

### 기타 테이블
- `users`: 카카오 로그인, 레벨, 정답률
- `daily_schedules`: 자동 발송 스케줄
- `deliveries`: 발송 기록

---

## Notion 데이터베이스 (20개 속성)

| 속성명 | 타입 | 설명 |
|--------|------|------|
| 문제 ID | 제목 | 2026_CSAT_Q01 |
| 연도, 문항번호, 배점, 난이도 | 숫자 | 기본 정보 |
| 시험, 상태, 과목, 단원, 정답유형 | 선택 | 분류 정보 |
| 정답, 출제의도, 풀이, 힌트1~3, 검수자 | 리치 텍스트 | 콘텐츠 |
| 원본링크, 이미지폴더 | URL | 링크 |
| 검수일 | 날짜 | 검수 완료일 |

**상태 옵션**: 검수 필요(보라) / 수정 필요(빨강) / 보류(회색) / 검수 완료(초록) / 발송 준비(파랑)

---

## 기술 스택

### Backend
- **Framework**: FastAPI 0.109+
- **Python**: 3.11+
- **ASGI Server**: Uvicorn
- **Database**: Supabase PostgreSQL
- **Storage**: Supabase Storage (`problem-images-v2`)
- **Authentication**: OAuth 2.0 (Kakao)
- **PDF**: PyMuPDF (fitz), 250 DPI
- **Notion**: notion-client 2.7.0

### Frontend
- **Admin**: HTML + Vanilla JS + React CDN
- **Problem Viewer**: Pure HTML/CSS/JavaScript
- **Crop Modal**: React CDN (`crop-modal.jsx`)

### External APIs
- **Kakao Login**: OAuth 2.0
- **Kakao Message**: 나에게 보내기 API
- **Notion API**: `notion_version="2022-06-28"`
- **Google Drive API**: PDF 수집

### 에이전트 시스템 (6개)
```
Commander (총괄)
├── PipelineAgent  (PDF 처리)
├── ContentAgent   (Notion/콘텐츠)
├── OpsAgent       (통계/모니터링)
├── DevAgent       (서버/의존성)
└── QAAgent        (테스트/검증)
```

---

## 개발 로드맵

### Phase 1: 기본 기능 (완료)
- [x] 카카오 로그인
- [x] Admin 페이지
- [x] 문제 뷰어
- [x] 카카오톡 메시지 발송
- [x] 이미지 크롭 도구

### Phase 2: 파이프라인 구축 (완료)
- [x] PDF → 이미지 변환 (PyMuPDF 250 DPI)
- [x] 하이브리드 문항 분리 (Template + OCR)
- [x] Supabase Storage/DB 업로드
- [x] 정답/배점/단원 분류

### Phase 3: 검수 시스템 (완료)
- [x] Notion 20개 속성 데이터베이스
- [x] sync_to_notion.py CLI (66문제 동기화)
- [x] 풍부한 검수 페이지 (이미지, 풀이 토글, 힌트 토글, 체크리스트)
- [x] 분석 대시보드

### Phase 4: UX 개선 (완료)
- [x] 문제 뷰어 전면 개선 (힌트 누적, Toast, 학습 피드백)
- [x] 전면 한국어화
- [x] Admin 반응형 + 진행률 바 + 썸네일
- [x] 색상 통일 (인디고 테마)

### Phase 5: 프로덕션 준비 (예정)
- [ ] 채널 메시지 발송 (나에게 보내기 → 친구 발송)
- [ ] 난이도 자동 계산 (정답률 기반)
- [ ] 도메인 구매 및 SSL
- [ ] Supabase RLS (Row Level Security)

---

## 프로젝트 파일 구조

```
Math_KICE/
├── run.py                      # CLI 메인
├── sync_to_notion.py           # Notion 동기화 CLI
├── requirements.txt
├── .env.example
├── schema_v2.sql               # DB 스키마
│
├── src/                        # 핵심 서비스
│   ├── pipeline.py             # 파이프라인
│   ├── pdf_converter.py        # PDF → PNG
│   ├── page_splitter.py        # 문항 분리
│   ├── image_processor.py      # 이미지 처리
│   ├── answer_parser.py        # 정답 파싱
│   ├── notion_service.py       # Notion API
│   ├── supabase_service.py     # DB CRUD
│   └── supabase_storage.py     # Storage
│
├── server/                     # FastAPI 서버
│   ├── main.py                 # 진입점
│   ├── problem_routes.py       # Admin + API
│   ├── scheduler.py            # 자동 발송
│   ├── dashboard_routes.py     # 분석
│   ├── kakao_message.py        # 카카오 메시지
│   ├── auth.py                 # 카카오 인증
│   └── static/                 # React
│       ├── crop-modal.jsx
│       └── shared-crop-components.jsx
│
├── agents/                     # 6-에이전트
│   ├── commander.py
│   ├── pipeline_agent.py
│   ├── content_agent.py
│   ├── ops_agent.py
│   ├── dev_agent.py
│   ├── qa_agent.py
│   └── run_agents.py
│
└── docs/                       # 문서
```

---

## 디버깅

```bash
# 서버 실행
python run.py

# Supabase 연결 테스트
python -c "from src.supabase_service import SupabaseService; s = SupabaseService(); print('OK')"

# Notion 동기화 테스트
python sync_to_notion.py --problem-id 2026_CSAT_Q01

# 에이전트 현황
python -m agents.run_agents status
```

---

**마지막 업데이트**: 2026-02-08
**버전**: 2.0.0
